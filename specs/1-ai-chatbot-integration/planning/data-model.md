# Data Model: AI Chatbot Integration

## Entity: Conversation

### Overview
Represents a chat session between a user and the AI assistant, containing metadata about the conversation.

### Fields
- **id** (int, primary key, auto-increment)
  - Unique identifier for the conversation
  - Auto-generated by the database
- **user_id** (str, foreign key to User table)
  - Links conversation to the owning user
  - Required for user data isolation
- **created_at** (datetime, default: current timestamp)
  - Timestamp when the conversation started
  - Used for sorting and historical tracking
- **updated_at** (datetime, default: current timestamp, auto-update)
  - Timestamp when the conversation was last updated
  - Helps with caching and freshness checks

### Relationships
- One-to-many with Message entity (one Conversation to many Messages)
- Many-to-one with User entity (many Conversations belong to one User)

### Validation Rules
- user_id must match an existing User record
- user_id must match the authenticated user for access
- created_at and updated_at are automatically managed

## Entity: Message

### Overview
Represents individual messages within a conversation, storing both user inputs and AI responses.

### Fields
- **id** (int, primary key, auto-increment)
  - Unique identifier for the message
  - Auto-generated by the database
- **user_id** (str, foreign key to User table)
  - Links message to the owning user
  - Enables user data isolation
- **conversation_id** (int, foreign key to Conversation table)
  - Links message to its parent conversation
  - Required for organizing messages
- **role** (str, enum: "user"|"assistant")
  - Indicates whether message is from user or AI
  - Required field with predefined values
- **content** (str, text content)
  - The actual message content
  - Variable length, supports rich text
- **created_at** (datetime, default: current timestamp)
  - Timestamp when the message was created
  - Used for chronological ordering

### Relationships
- Many-to-one with Conversation entity (many Messages belong to one Conversation)
- Many-to-one with User entity (many Messages belong to one User)

### Validation Rules
- role must be either "user" or "assistant"
- conversation_id must point to an existing Conversation
- user_id must match authenticated user for access
- content length should be reasonable (e.g., < 10,000 characters)
- user_id must match the conversation's user_id

## State Transitions

### Conversation
- Created: When user initiates first message without existing conversation_id
- Active: During ongoing conversation (updated_at changes with each message)
- Inactive: After extended period without activity (potential cleanup candidate)

### Message
- Pending: Immediately after user submission, before AI response
- Processed: After AI has processed the message and responded
- Archived: After conversation cleanup (if applicable)

## Indexes

### Conversation Entity
- Index on user_id for efficient user-specific queries
- Index on created_at for chronological sorting
- Composite index on (user_id, created_at) for optimized user timeline queries

### Message Entity
- Index on conversation_id for efficient conversation retrieval
- Index on user_id for user-specific queries
- Index on created_at for chronological ordering
- Composite index on (conversation_id, created_at) for ordered message retrieval within conversations

## Constraints

### Referential Integrity
- Foreign key constraint on user_id in both entities
- Foreign key constraint on conversation_id in Message entity
- Cascade delete: Deleting Conversation removes related Messages

### Security Constraints
- Row-level security: Users can only access their own Conversations and Messages
- Authentication required for all access operations
- User ID in JWT token must match record's user_id

## Sample Queries

### Get user's recent conversations
```sql
SELECT * FROM conversation
WHERE user_id = $1
ORDER BY updated_at DESC
LIMIT 10;
```

### Get conversation messages
```sql
SELECT * FROM message
WHERE conversation_id = $1
ORDER BY created_at ASC;
```

### Create new message
```sql
INSERT INTO message (user_id, conversation_id, role, content)
VALUES ($1, $2, $3, $4)
RETURNING *;
```